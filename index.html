<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELO žebříček</title>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#111; color:#eee; }

    header { padding: 22px 18px; border-bottom: 1px solid rgba(255,255,255,.12); }
    header .wrap { max-width: 1100px; margin: 0 auto; display: flex; gap: 16px; align-items: flex-start; justify-content: space-between; }
    h1 { margin: 0 0 6px; font-size: 26px; }
    .muted { opacity: .75; }
    .credit { margin-top: 6px; }

    main { max-width: 1100px; margin: 0 auto; padding: 16px; }

    .card { margin-top: 14px; border: 1px solid rgba(255,255,255,.12); border-radius: 18px; overflow: hidden; background: rgba(255,255,255,.03); }

    .toolbar { display:flex; gap: 12px; align-items:center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,.10); }
    .left { display:flex; gap: 12px; align-items:center; }
    .right { display:flex; gap: 10px; align-items:center; }

    .badge {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }

    input[type="search"]{
      width: min(360px, 60vw);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: transparent;
      color: inherit;
    }

    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: transparent;
      color: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 12px; }
    thead th { font-size: 12px; letter-spacing: .06em; text-transform: uppercase; opacity: .7; }
    tbody tr { border-top: 1px solid rgba(255,255,255,.08); }
    tbody tr:hover { background: rgba(255,255,255,.05); }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .rank { width: 80px; opacity: .85; }

    #error { display:none; margin-top: 12px; white-space: pre-wrap; color: #ff6b6b; }

    footer { padding: 12px; opacity: .7; font-size: 12px; border-top: 1px solid rgba(255,255,255,.10); }

    @media (max-width: 740px) {
      header .wrap { flex-direction: column; }
      .right { width: 100%; justify-content: space-between; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div>
        <h1>ELO žebříček</h1>
        <div class="muted">Načítáno z Google Sheets (list: “Elo standings”).</div>
        <div class="credit muted">
          Za veškerá data děkujeme <b>Ervinovi Kučovi</b>, který data současně zpravuje:
        </div>
      </div>

      <div class="badge" id="lastDataBadge">poslední data: načítám…</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="toolbar">
        <div class="left">
          <span id="status" class="badge">Načítám…</span>
          <input id="search" type="search" placeholder="Hledat hráče…" autocomplete="off" />
        </div>

        <div class="right">
          <button id="refresh" type="button">Znovu načíst</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th class="rank">Pořadí</th>
              <th>Player</th>
              <th class="num">Rating</th>
              <th class="num">Games</th>
              <th class="num">Win</th>
              <th class="num">Loss</th>
              <th class="num">Draw</th>
              <th class="num">Winrate</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        Pořadí je „locknuté“ po načtení dat (vyhledávání ho nemění).
      </footer>
    </div>

    <div id="error"></div>
  </main>

<script>
  // --- CSV endpointy ---
  const SHEET_ID = "1y98bzsIRpVv0_cGNfbITapucO5A6izeEz5lTM92ZbIA";
  const ELO_SHEET_NAME = "Elo standings";
  const DATA_SHEET_NAME = "Data";

  const ELO_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(ELO_SHEET_NAME)}`;

  const DATA_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;

  // --- DOM ---
  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const errorEl = document.getElementById("error");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refresh");
  const lastDataBadge = document.getElementById("lastDataBadge");

  let allRows = [];

  function setStatus(text) { statusEl.textContent = text; }
  function showError(msg) { errorEl.style.display = "block"; errorEl.textContent = msg; }
  function hideError() { errorEl.style.display = "none"; errorEl.textContent = ""; }

  function escapeHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function normalizeKey(s) {
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu, "");
  }

  // CSV parser s podporou uvozovek
  function parseCSV(csvText) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < csvText.length; i++) {
      const c = csvText[i];
      const next = csvText[i + 1];

      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; }
      else if (c === '"') inQuotes = !inQuotes;
      else if (c === "," && !inQuotes) { row.push(cur); cur = ""; }
      else if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(x => x.trim() !== "")) rows.push(row);
        row = [];
      } else {
        cur += c;
      }
    }

    if (cur.length || row.length) {
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);
    }

    return rows;
  }

  function toNumber(x) {
    if (x == null) return NaN;
    const s = x.toString().replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  async function fetchUtf8Text(url) {
    const res = await fetch(url, { cache: "no-store" });
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);
    return { res, text };
  }

  function render(rows) {
    const q = normalizeKey(searchEl.value);

    // filtrujeme, ale rank necháváme původní ("locknutý")
    const filtered = rows.filter(r => !q || normalizeKey(r.player).includes(q));
    filtered.sort((a, b) => a.rank - b.rank);

    tbody.innerHTML = "";

    if (!filtered.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">Nic nenalezeno.</td>`;
      tbody.appendChild(tr);
      return;
    }

    filtered.forEach((r) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${r.rank}</td>
        <td>${escapeHtml(r.player)}</td>
        <td class="num">${Number.isFinite(r.rating) ? r.rating.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.games) ? r.games.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.win) ? r.win.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.loss) ? r.loss.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.draw) ? r.draw.toFixed(0) : ""}</td>
        <td class="num">${escapeHtml(r.winrate || "")}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function loadLastData() {
    // Bere poslední neprázdnou hodnotu ze sloupce B na listu "Data"
    try {
      const u = new URL(DATA_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      if (text.trim().startsWith("<")) throw new Error("List Data není dostupný (HTML místo CSV).");

      const rows = parseCSV(text);
      if (rows.length < 2) {
        lastDataBadge.textContent = "poslední data: (nenalezeno)";
        return;
      }

      // přeskočíme hlavičku a vezmeme sloupec B (index 1)
      let last = "";
      for (let i = 1; i < rows.length; i++) {
        const val = (rows[i][1] ?? "").toString().trim();
        if (val) last = val;
      }

      lastDataBadge.textContent = `poslední data: ${last || "(nenalezeno)"}`;
    } catch (e) {
      lastDataBadge.textContent = "poslední data: chyba";
    }
  }

  async function loadStandings() {
    hideError();
    setStatus("Načítám…");
    refreshBtn.disabled = true;

    try {
      const u = new URL(ELO_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("Místo CSV přišlo HTML (tabulka není veřejná / není publikovaná).");

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("Prázdné CSV.");

      const headers = rows[0].map(h => normalizeKey(h));
      const idx = (name) => headers.indexOf(name);

      // Přesně podle tvých sloupců A–G:
      const iPlayer  = idx("player");
      const iRating  = idx("rating");
      const iGames   = idx("games");
      const iWin     = idx("win");
      const iLoss    = idx("loss");
      const iDraw    = idx("draw");
      // v CSV může být "winrate" nebo "Winrate" → normalizeKey to srovná
      const iWinrate = headers.findIndex(h => h === "winrate" || h.includes("winrate"));

      if ([iPlayer, iRating, iGames, iWin, iLoss, iDraw].some(i => i === -1) || iWinrate === -1) {
        throw new Error(
          "Nenašel jsem všechny požadované sloupce A–G (player, rating, games, win, loss, draw, winrate).\n" +
          `Hlavičky v CSV: ${headers.join(", ")}`
        );
      }

      const loaded = rows.slice(1)
        .map(r => ({
          player:  (r[iPlayer] ?? "").trim(),
          rating:  toNumber(r[iRating]),
          games:   toNumber(r[iGames]),
          win:     toNumber(r[iWin]),
          loss:    toNumber(r[iLoss]),
          draw:    toNumber(r[iDraw]),
          winrate: (r[iWinrate] ?? "").toString().trim()
        }))
        .filter(x => x.player.length > 0);

      // seřadíme podle ratingu
      loaded.sort((a, b) => (b.rating || -Infinity) - (a.rating || -Infinity));

      // "lock" pořadí po načtení
      allRows = loaded.map((p, i) => ({ ...p, rank: i + 1 }));

      setStatus(`Načteno: ${allRows.length}`);
      render(allRows);
    } catch (e) {
      setStatus("Chyba");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  async function loadAll() {
    // oboje najednou
    await Promise.all([loadStandings(), loadLastData()]);
  }

  searchEl.addEventListener("input", () => render(allRows));
  refreshBtn.addEventListener("click", loadAll);

  loadAll();
</script>
</body>
</html>
